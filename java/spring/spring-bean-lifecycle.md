# 스프링 빈 생명주기

> 스프링 빈의 생명주기를 알아보자.

- [스프링 빈 생명주기](#스프링-빈-생명주기)
  - [스프링 빈(Spring Bean) 이란?](#스프링-빈spring-bean-이란)
  - [스프링 빈 생명주기](#스프링-빈-생명주기-1)
  - [스프링 빈 생명주기 콜백](#스프링-빈-생명주기-콜백)
    - [1. 스프링 인터페이스 활용](#1-스프링-인터페이스-활용)
    - [2. 스프링 빈 설정 정보에서 콜백 메소드 지정](#2-스프링-빈-설정-정보에서-콜백-메소드-지정)
    - [3. `@PostConstruct, @PreDestroy` 어노테이션 사용](#3-postconstruct-predestroy-어노테이션-사용)

## 스프링 빈(Spring Bean) 이란?

스프링 IOC 컨테이너에서 관리하는 자바 객체를 스프링 빈이라고 한다.

여기서 IOC란 Inversion Of Control(제어의 역전) 의 줄임말로, 객체의 생성부터 관리까지의 주체를 프로그래머가 아닌 시스템에서 역할하는 것을 의미한다.

이때 관리 대상으로 포함될 객체를 스프링 빈이라고 하고, 이를 관리하는 시스템을 스프링 IOC 컨테이너라고 한다.

## 스프링 빈 생명주기

일반적으로 스프링 빈은 `스프링 컨테이너 생성, 객체(스프링 빈) 생성, 의존 관계 주입, 객체 초기화 - 소멸` 순서의 생명주기를 가진다.

> 참고: 의존관계 주입을 위한 방법 중, 생성자 주입을 사용할 경우 객체의 생성과 의존관계 주입이 동시에 일어난다.

- 스프링 컨테이너 생성: 스프링 프레임워크에서 비어있는 스프링 컨테이너를 생성한다.
- 스프링 빈 생성: Configuration 파일에서 `@Bean`과 같은 어노테이션으로 직접 스프링 빈을 등록하거나, `@ComponentScan`을 통해 경로에서 스프링 빈을 찾아 등록하는 방법으로 스프링 빈을 컨테이너에 생성하여 등록한다.
- 의존 관계 주입: 객체를 생성할 때 스프링 컨테이너의 등록된 정보를 통해 의존관계를 주입한다. (이를 통해 스프링 빈 객체는 싱글톤 패턴을 보장한다.)
- `초기화, 소멸`: 콜백 메소드를 호출한다. (다음 챕터에서 자세히 살펴보자.)

## 스프링 빈 생명주기 콜백

- 먼저 스프링에서 의존 관계 주입 종료 시 스프링 빈의 콜백 메소드를 통해 초기화 단계임을 알린다.
- 이를 통해 생명주기 상에서 스프링 빈이 생성되고, 의존 관계 주입이 종료된 후 초기화 단계가 실행된다.
- 마찬가지로 소멸 단계에서도 스프링 컨테이너가 종료되기 직전에 콜백 메소드를 통해 소멸 단계임을 알린다.

스프링 빈의 생명주기 콜백 종류에는 크게 3가지 방식이 있다.

### 1. 스프링 인터페이스 활용

스프링 빈에 등록할 클래스에서 **스프링에서 제공**하는 아래의 두 인터페이스를 implements하여 콜백 메소드를 지정할 수 있다.

- `InitializingBean`
- `DisposableBean`

```java
@Component
public class MyBean implements InitializingBean, DisposableBean {
    @Override
    public void afterPropertiesSet() throws Exception {
        // 초기화 콜백
    }

    @Override
    public void destroy() throws Exception {
        // 소멸 콜백
    }
}
```

위와 같이 인터페이스에서 제공하는 메소드를 Override하여 콜백 메소드를 정의할 수 있다.

그러나 단점으로는 위와 같은 방식은 스프링 프레임워크에서 제공하는 인터페이스를 활용한 것이기 때문에 **스프링 인터페이스에 의존적**이다. (따라서 좋은 방법이 아니다.)

따라서 외부 라이브러리와 같이 스프링 인터페이스를 적용할 수 없는 환경에서는 사용할 수 없다는 단점이 있다.

### 2. 스프링 빈 설정 정보에서 콜백 메소드 지정

스프링 Configuration 파일에서 스프링 빈을 정의할 때 콜백 메소드를 지정할 수 있다.

예를 들어 Java Config 방식으로 스프링 빈을 등록한다면, `@Bean` 어노테이션의 속성으로 생성과 소멸 시 콜백 메소드를 지정할 수 있다.

```java
public class MyBean {

    public void init() throws Exception {
        // 초기화 콜백
    }

    public void close() throws Exception {
        // 소멸 콜백
    }
}

@Configuration
public class AppConfig {

    @Bean(initMethod="init", destroyMethod="close")
    public MyBean myBean() {
        // MyBean 클래스를 스프링 빈으로 등록
    }
}
```

이 방식을 사용하면 1번의 문제점인 스프링 프레임워크에 종속적이라는 문제를 해결할 수 있다.

그러나 매번 설정 파일에서 생성 및 소멸 메소드를 지정해야 하는 번거로움이 있다.

> 추론(inference) 특징: `@Bean`의 특징으로, 대부분의 객체의 소멸 콜백 메소드 명이 `close` 혹은 `shutdown` 이므로 명시하지 않아도 자동으로 소멸 콜백 메소드를 등록한다.

### 3. `@PostConstruct, @PreDestroy` 어노테이션 사용

스프링에서 가장 권장하는 방법으로, 가장 많이 사용하는 방식이다.

- 스프링 프레임워크의 기술이 아닌 자바 표준 기술이다.
- 생성 콜백 메소드 위에 `@PostContruct` 어노테이션을, 소멸 콜백 메소드 위에 `@PreDestroy` 어노테이션을 붙이면 된다.

```java
@Component
public class MyBean {

    @PostConstruct
    public void init() throws Exception {
        // 초기화 콜백
    }

    @PreDestroy
    public void close() throws Exception {
        // 소멸 콜백
    }
}
```

위 방식의 유일한 단점은 커스터마이징이 불가능한 라이브러리에서 콜백 함수를 적용하고 싶을 때 불가능하다는 점이다.

이러한 경우 2번의 스프링 빈 설정 정보에서 생성 및 소멸 콜백 메소드를 지정하는 방식으로 해결할 수 있다.
